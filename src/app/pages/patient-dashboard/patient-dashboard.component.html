<div class="dashboard-container">
  <div class="dashboard-header">
    <div class="header-content">
      <div class="header-info">
        <h1>Tableau de Bord Patient</h1>
        <p>G√©rez vos rendez-vous et votre sant√©</p>
      </div>
      <div class="header-profile">
        <div class="profile-menu">
          <div class="profile-avatar" (click)="toggleProfileMenu()">
            <div class="avatar-image" *ngIf="monProfil?.photo">
              <img [src]="getSafePhotoUrl()" 
                   alt="Photo de profil"
                   (error)="onPhotoError($event)">
            </div>
            <div class="avatar-placeholder" *ngIf="!monProfil?.photo">
              {{ getInitials() }}
            </div>
            <span class="profile-name">
              {{ monProfil?.prenom }} {{ monProfil?.nom }}
            </span>
            <span class="dropdown-arrow">‚ñº</span>
          </div>
          
          <div class="profile-dropdown" *ngIf="showProfileMenu">
            <div class="dropdown-item" (click)="ouvrirModalProfil()">
              <span class="icon">üë§</span>
              Modifier mon profil
            </div>
            <div class="dropdown-item" (click)="deconnexion()">
              <span class="icon">üö™</span>
              D√©connexion
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Gestion des erreurs -->
  <div *ngIf="hasConnectionError" class="error-banner">
    <div class="error-content">
      <span class="error-icon">‚ö†Ô∏è</span>
      <span class="error-message">{{ errorMessage }}</span>
      <button class="btn btn-outline-light btn-sm" (click)="retryLoad()">
        R√©essayer
      </button>
    </div>
  </div>

  <!-- Navigation par onglets -->
  <nav class="tabs-navigation">
    <button 
      class="tab-btn" 
      [class.active]="activeTab === PatientTabs.TABLEAU_BORD"
      (click)="setActiveTab(PatientTabs.TABLEAU_BORD)">
      üìä Tableau de Bord
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === PatientTabs.RENDEZ_VOUS"
      (click)="setActiveTab(PatientTabs.RENDEZ_VOUS)">
      üìÖ Mes Rendez-vous
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === PatientTabs.DOCTEURS"
      (click)="setActiveTab(PatientTabs.DOCTEURS)">
      üë®‚Äç‚öïÔ∏è Trouver un Docteur
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab === PatientTabs.PROFIL"
      (click)="setActiveTab(PatientTabs.PROFIL)">
      üë§ Mon Profil
    </button>
  </nav>

  <!-- Contenu des onglets -->
  <main class="tab-content">
    
    <!-- Onglet Tableau de Bord -->
    <section *ngIf="activeTab === PatientTabs.TABLEAU_BORD" class="tab-pane">
      
      <!-- Statistiques -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-info">
            <div class="stat-number">{{ dashboardData.statistiques.totalRendezVous }}</div>
            <div class="stat-label">RDV Totaux</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-info">
            <div class="stat-number">{{ dashboardData.statistiques.rendezVousConfirmes }}</div>
            <div class="stat-label">RDV Confirm√©s</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚ùå</div>
          <div class="stat-info">
            <div class="stat-number">{{ dashboardData.statistiques.rendezVousAnnules }}</div>
            <div class="stat-label">RDV Annul√©s</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚è∞</div>
          <div class="stat-info">
            <div class="stat-number" *ngIf="dashboardData.statistiques.prochainRendezVous; else aucunRdv">
              {{ getDateCourte(dashboardData.statistiques.prochainRendezVous) }}
            </div>
            <ng-template #aucunRdv>
              <div class="stat-number">Aucun</div>
            </ng-template>
            <div class="stat-label">Prochain RDV</div>
          </div>
        </div>
      </div>

      <!-- Actions Rapides -->
      <section class="quick-actions">
        <h2>Actions Rapides</h2>
        <div class="actions-grid">
          <button class="action-card" (click)="prendreRendezVous()">
            <div class="action-icon">‚ûï</div>
            <div class="action-text">Prendre RDV</div>
          </button>
          <button class="action-card" (click)="setActiveTab(PatientTabs.RENDEZ_VOUS)">
            <div class="action-icon">üìã</div>
            <div class="action-text">Mes RDV</div>
          </button>
          <button class="action-card" (click)="setActiveTab(PatientTabs.DOCTEURS)">
            <div class="action-icon">üîç</div>
            <div class="action-text">Trouver Docteur</div>
          </button>
          <button class="action-card" (click)="ouvrirModalProfil()">
            <div class="action-icon">üë§</div>
            <div class="action-text">Mon Profil</div>
          </button>
        </div>
      </section>

      <!-- Prochains Rendez-vous -->
      <section class="recent-section">
        <header class="section-header">
          <h2>Prochains Rendez-vous</h2>
          <button class="btn btn-outline" (click)="setActiveTab(PatientTabs.RENDEZ_VOUS)">
            Voir Tout
          </button>
        </header>

        <div *ngIf="dashboardData.prochainsRendezVous.length === 0" class="empty-state">
          <div class="empty-icon">üìÖ</div>
          <p>Aucun rendez-vous √† venir</p>
          <small>Prenez votre premier rendez-vous pour commencer</small>
          <button class="btn btn-primary" (click)="prendreRendezVous()">
            Prendre un Rendez-vous
          </button>
        </div>

        <div *ngIf="dashboardData.prochainsRendezVous.length > 0" class="rendez-vous-list">
          <article *ngFor="let rdv of dashboardData.prochainsRendezVous" class="rendez-vous-card">
            <header class="rdv-header">
              <div class="docteur-info">
                <h3>Dr. {{ rdv.docteur.prenom }} {{ rdv.docteur.nom }}</h3>
                <p class="specialite">{{ rdv.docteur.specialite.titre }}</p>
              </div>
              <div class="rdv-time">
                <time class="date-time">{{ getDateFormatee(rdv.dateHeure) }}</time>
                <span class="time-badge">{{ getHeureFromDate(rdv.dateHeure) }}</span>
                <span class="badge" [class]="getStatutBadgeClass(rdv.statut)">
                  {{ rdv.statut | lowercase }}
                </span>
              </div>
            </header>
            
            <div class="rdv-details">
              <p><strong>Motif:</strong> {{ rdv.motif }}</p>
              <p *ngIf="rdv.docteur.adresse"><strong>Adresse:</strong> {{ rdv.docteur.adresse }}</p>
              <p *ngIf="rdv.docteur.telephone"><strong>T√©l√©phone:</strong> {{ rdv.docteur.telephone }}</p>
              <p *ngIf="!rdv.docteur.adresse && !rdv.docteur.telephone">
                <strong>Contact:</strong> Informations non disponibles
              </p>
            </div>

            <footer class="rdv-actions" *ngIf="rdv.statut !== 'TERMINE' && rdv.statut !== 'ANNULE'">
              <button *ngIf="rdv.statut === 'PLANIFIE'" 
                      class="btn btn-success btn-sm" 
                      (click)="confirmerRendezVous(rdv.id)">
                Confirmer
              </button>
              <button class="btn btn-danger btn-sm" (click)="annulerRendezVous(rdv.id)">
                Annuler
              </button>
            </footer>
          </article>
        </div>
      </section>

      <!-- Rendez-vous R√©cents -->
      <section class="recent-section">
        <header class="section-header">
          <h2>Rendez-vous R√©cents</h2>
          <button class="btn btn-outline" (click)="setActiveTab(PatientTabs.RENDEZ_VOUS)">
            Voir Tout
          </button>
        </header>

        <div *ngIf="dashboardData.rendezVousRecents.length === 0" class="empty-state">
          <div class="empty-icon">üìã</div>
          <p>Aucun rendez-vous r√©cent</p>
        </div>

        <div *ngIf="dashboardData.rendezVousRecents.length > 0" class="rendez-vous-list">
          <article *ngFor="let rdv of dashboardData.rendezVousRecents" 
               class="rendez-vous-card" 
               [class.past]="estRendezVousPasse(rdv.dateHeure)">
            <header class="rdv-header">
              <div class="docteur-info">
                <h3>Dr. {{ rdv.docteur.prenom }} {{ rdv.docteur.nom }}</h3>
                <p class="specialite">{{ rdv.docteur.specialite.titre }}</p>
                <p class="docteur-contact">
                  {{ rdv.docteur.telephone ? rdv.docteur.telephone : 'T√©l. non renseign√©' }}
                </p>
              </div>
              <div class="rdv-time">
                <time class="date-time">{{ getDateFormatee(rdv.dateHeure) }}</time>
                <span class="time-badge">{{ getHeureFromDate(rdv.dateHeure) }}</span>
                <span class="badge" [class]="getStatutBadgeClass(rdv.statut)">
                  {{ rdv.statut | lowercase }}
                </span>
              </div>
            </header>
            
            <div class="rdv-details">
              <p><strong>Motif:</strong> {{ rdv.motif }}</p>
              <p *ngIf="rdv.docteur.adresse"><strong>Adresse:</strong> {{ rdv.docteur.adresse }}</p>
              <p *ngIf="!rdv.docteur.adresse"><strong>Adresse:</strong> Non sp√©cifi√©e</p>
              <p *ngIf="rdv.notes"><strong>Notes:</strong> {{ rdv.notes }}</p>
            </div>
          </article>
        </div>
      </section>
    </section>

    <!-- Onglet Mes Rendez-vous -->
    <section *ngIf="activeTab === PatientTabs.RENDEZ_VOUS" class="tab-pane">
      <header class="section-header">
        <h2>Mes Rendez-vous</h2>
        <div class="header-actions">
          <button class="btn btn-primary" (click)="prendreRendezVous()">
            + Nouveau Rendez-vous
          </button>
          <button class="btn btn-outline" (click)="loadDonnees()" [disabled]="isLoading">
            üîÑ Actualiser
          </button>
        </div>
      </header>

      <div *ngIf="rendezVous.length === 0" class="empty-state">
        <div class="empty-icon">üìã</div>
        <p>Aucun rendez-vous planifi√©</p>
        <small>Prenez votre premier rendez-vous pour commencer</small>
        <button class="btn btn-primary" (click)="prendreRendezVous()">
          Prendre un Rendez-vous
        </button>
      </div>

      <div *ngIf="rendezVous.length > 0" class="rendez-vous-list">
        <article *ngFor="let rdv of rendezVous" 
             class="rendez-vous-card" 
             [class.past]="estRendezVousPasse(rdv.dateHeure)">
          <header class="rdv-header">
            <div class="docteur-info">
              <h3>Dr. {{ rdv.docteur.prenom }} {{ rdv.docteur.nom }}</h3>
              <p class="specialite">{{ rdv.docteur.specialite.titre }}</p>
              <p class="docteur-contact">{{ rdv.docteur.email }}</p>
              <p class="docteur-contact">
                {{ rdv.docteur.telephone ? rdv.docteur.telephone : 'T√©l. non renseign√©' }}
              </p>
            </div>
            <div class="rdv-time">
              <time class="date-time">{{ getDateFormatee(rdv.dateHeure) }}</time>
              <span class="time-badge">{{ getHeureFromDate(rdv.dateHeure) }}</span>
              <span class="badge" [class]="getStatutBadgeClass(rdv.statut)">
                {{ rdv.statut | lowercase }}
              </span>
            </div>
          </header>
          
          <div class="rdv-details">
            <p><strong>Motif:</strong> {{ rdv.motif }}</p>
            <p *ngIf="rdv.docteur.adresse"><strong>Adresse:</strong> {{ rdv.docteur.adresse }}</p>
            <p *ngIf="!rdv.docteur.adresse"><strong>Adresse:</strong> Non sp√©cifi√©e</p>
            <p *ngIf="rdv.notes"><strong>Notes:</strong> {{ rdv.notes }}</p>
          </div>

          <footer class="rdv-actions" *ngIf="rdv.statut !== 'TERMINE' && rdv.statut !== 'ANNULE'">
            <button *ngIf="rdv.statut === 'PLANIFIE'" 
                    class="btn btn-success btn-sm" 
                    (click)="confirmerRendezVous(rdv.id)">
              Confirmer
            </button>
            <button class="btn btn-danger btn-sm" (click)="annulerRendezVous(rdv.id)">
              Annuler
            </button>
          </footer>
        </article>
      </div>
    </section>

    <!-- Onglet Trouver un Docteur -->
    <section *ngIf="activeTab === PatientTabs.DOCTEURS" class="tab-pane">
      <header class="section-header">
        <h2>Trouver un Docteur</h2>
        <p>Recherchez et prenez rendez-vous avec nos sp√©cialistes</p>
      </header>

      <!-- Barre de recherche -->
      <div class="search-bar">
        <input 
          type="text" 
          placeholder="Rechercher un docteur par nom, sp√©cialit√©..."
          class="search-input"
          (input)="onSearchDocteurs($event)"
          aria-label="Rechercher un docteur">
      </div>

      <div *ngIf="docteurs.length === 0" class="empty-state">
        <div class="empty-icon">üë®‚Äç‚öïÔ∏è</div>
        <p>Aucun docteur disponible</p>
        <small>Veuillez r√©essayer plus tard</small>
      </div>

      <div *ngIf="docteurs.length > 0" class="docteurs-grid">
        <article *ngFor="let docteur of docteurs" class="docteur-card">
          <header class="docteur-header">
            <div class="docteur-avatar">
              <div class="avatar-image" *ngIf="docteur.photo">
                <img [src]="getPhotoUrl(docteur.photo)" 
                     alt="Photo du docteur {{ docteur.prenom }} {{ docteur.nom }}"
                     (error)="onPhotoError($event)">
              </div>
              <div class="avatar-placeholder" *ngIf="!docteur.photo">
                {{ docteur.prenom.charAt(0) }}{{ docteur.nom.charAt(0) }}
              </div>
            </div>
            <div class="docteur-info">
              <h3>Dr. {{ docteur.prenom }} {{ docteur.nom }}</h3>
              <p class="specialite">{{ docteur.specialite.titre }}</p>
              <div class="rating">
                <span class="stars">‚≠ê {{ docteur.noteMoyenne || '0.0' }}/5</span>
                <span class="reviews">({{ docteur.nombreAvis || 0 }} avis)</span>
              </div>
            </div>
          </header>

          <div class="docteur-details">
            <p><strong>Exp√©rience:</strong> {{ docteur.anneesExperience || 0 }} ans</p>
            <p><strong>Tarif:</strong> {{ docteur.tarifConsultation || 'Non sp√©cifi√©' }} ‚Ç¨</p>
            <p><strong>Langues:</strong> {{ docteur.langue || 'Fran√ßais' }}</p>
            <p *ngIf="docteur.adresse"><strong>Adresse:</strong> {{ docteur.adresse }}</p>
            <p *ngIf="docteur.telephone"><strong>T√©l√©phone:</strong> {{ docteur.telephone }}</p>
          </div>

          <footer class="docteur-actions">
            <button class="btn btn-primary" (click)="prendreRendezVousAvecDocteur(docteur.id)">
              Prendre RDV
            </button>
          </footer>
        </article>
      </div>
    </section>

    <!-- Onglet Mon Profil -->
    <section *ngIf="activeTab === PatientTabs.PROFIL" class="tab-pane">
      <header class="section-header">
        <h2>Mon Profil</h2>
        <button class="btn btn-outline" (click)="ouvrirModalProfil()">
          ‚úèÔ∏è Modifier
        </button>
      </header>

      <div *ngIf="monProfil; else profilNonCharge" class="profil-view">
        <header class="profil-header">
          <div class="photo-section">
            <div class="photo-preview" *ngIf="monProfil.photo">
              <img [src]="getSafePhotoUrl()" 
                   alt="Photo de profil"
                   (error)="onPhotoError($event)">
            </div>
            <div class="photo-placeholder" *ngIf="!monProfil.photo">
              {{ getInitials() }}
            </div>
          </div>
          <div class="profil-info">
            <h2>{{ monProfil.prenom }} {{ monProfil.nom }}</h2>
            <p class="profil-email">{{ monProfil.email }}</p>
            <p class="profil-age" *ngIf="monProfil.dateNaissance">
              {{ calculerAge(monProfil.dateNaissance) }} ans
            </p>
          </div>
        </header>

        <div class="profil-details">
          <section class="detail-section">
            <h3>Informations Personnelles</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>T√©l√©phone</label>
                <p>{{ monProfil.telephone || 'Non renseign√©' }}</p>
              </div>
              <div class="detail-item">
                <label>Date de Naissance</label>
                <p>{{ monProfil.dateNaissance ? getDateFormatee(monProfil.dateNaissance) : 'Non renseign√©e' }}</p>
              </div>
              <div class="detail-item">
                <label>Groupe Sanguin</label>
                <p>{{ monProfil.groupeSanguin || 'Non renseign√©' }}</p>
              </div>
            </div>
          </section>

          <section class="detail-section">
            <h3>Adresse</h3>
            <p>{{ monProfil.adresse || 'Non renseign√©e' }}</p>
          </section>

          <section class="detail-section" *ngIf="monProfil.antecedentsMedicaux">
            <h3>Ant√©c√©dents M√©dicaux</h3>
            <p>{{ monProfil.antecedentsMedicaux }}</p>
          </section>

          <section class="detail-section">
            <h3>Informations du Compte</h3>
            <div class="detail-grid">
              <div class="detail-item">
                <label>Membre depuis</label>
                <p>{{ getDateFormatee(monProfil.dateCreation) }}</p>
              </div>
              <div class="detail-item">
                <label>Statut</label>
                <span class="badge badge-success">
                  {{ monProfil.actif ? 'actif' : 'inactif' }}
                </span>
              </div>
            </div>
          </section>
        </div>
      </div>

      <ng-template #profilNonCharge>
        <div class="empty-state">
          <div class="empty-icon">üë§</div>
          <p>Profil non charg√©</p>
          <button class="btn btn-primary" (click)="loadMonProfil()">
            Charger mon profil
          </button>
        </div>
      </ng-template>
    </section>
  </main>

  <!-- Modal Modifier Profil -->
  <div *ngIf="showModalProfil" class="modal-overlay">
    <div class="modal large-modal" role="dialog" aria-labelledby="modal-title">
      <header class="modal-header">
        <h3 id="modal-title">Modifier mon Profil</h3>
        <button class="close-btn" (click)="fermerModalProfil()" aria-label="Fermer">√ó</button>
      </header>
      
      <div class="modal-body">
        <!-- Photo de profil -->
        <section class="photo-section">
          <div class="photo-upload">
            <div class="photo-preview" *ngIf="photoPreview">
              <img [src]="photoPreview" alt="Aper√ßu de la nouvelle photo de profil">
              <button class="btn-remove-photo" (click)="supprimerPhoto()" aria-label="Supprimer la photo">√ó</button>
            </div>
            <div class="photo-placeholder" *ngIf="!photoPreview">
              <div class="placeholder-icon">üë§</div>
              <p>Aucune photo</p>
            </div>
            <div class="photo-actions">
              <input 
                type="file" 
                id="photoInput"
                accept="image/*"
                (change)="onPhotoSelected($event)"
                aria-describedby="photoHelp"
                style="display: none;">
              <label for="photoInput" class="btn btn-outline btn-sm">
                üì∑ Choisir une photo
              </label>
              <small id="photoHelp">Formats: JPG, PNG ‚Ä¢ Max: 5MB</small>
            </div>
          </div>
        </section>

        <!-- Informations personnelles -->
        <section class="form-section">
          <h4>Informations Personnelles</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="nom">Nom *</label>
              <input 
                type="text" 
                id="nom"
                [(ngModel)]="profilForm.nom"
                class="form-control"
                placeholder="Votre nom"
                required>
            </div>
            <div class="form-group">
              <label for="prenom">Pr√©nom *</label>
              <input 
                type="text" 
                id="prenom"
                [(ngModel)]="profilForm.prenom"
                class="form-control"
                placeholder="Votre pr√©nom"
                required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="telephone">T√©l√©phone</label>
              <input 
                type="tel" 
                id="telephone"
                [(ngModel)]="profilForm.telephone"
                class="form-control"
                placeholder="+33 1 23 45 67 89">
            </div>
            <div class="form-group">
              <label for="dateNaissance">Date de Naissance *</label>
              <input 
                type="date" 
                id="dateNaissance"
                [(ngModel)]="profilForm.dateNaissance"
                class="form-control"
                [max]="getTomorrowDate()"
                required>
            </div>
          </div>

          <div class="form-group">
            <label for="adresse">Adresse</label>
            <textarea 
              id="adresse"
              [(ngModel)]="profilForm.adresse"
              class="form-control"
              rows="2"
              placeholder="Votre adresse compl√®te"></textarea>
          </div>
        </section>

        <!-- Informations m√©dicales -->
        <section class="form-section">
          <h4>Informations M√©dicales</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="groupeSanguin">Groupe Sanguin</label>
              <select id="groupeSanguin" [(ngModel)]="profilForm.groupeSanguin" class="form-control">
                <option value="">S√©lectionnez</option>
                <option value="A+">A+</option>
                <option value="A-">A-</option>
                <option value="B+">B+</option>
                <option value="B-">B-</option>
                <option value="AB+">AB+</option>
                <option value="AB-">AB-</option>
                <option value="O+">O+</option>
                <option value="O-">O-</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="antecedents">Ant√©c√©dents M√©dicaux</label>
            <textarea 
              id="antecedents"
              [(ngModel)]="profilForm.antecedentsMedicaux"
              class="form-control"
              rows="4"
              placeholder="D√©crivez vos ant√©c√©dents m√©dicaux, allergies, traitements en cours..."></textarea>
          </div>
        </section>
      </div>

      <footer class="modal-footer">
        <button class="btn btn-secondary" (click)="fermerModalProfil()">Annuler</button>
        <button class="btn btn-primary" (click)="mettreAJourProfil()" [disabled]="isLoading">
          {{ isLoading ? 'Enregistrement...' : 'Enregistrer' }}
        </button>
      </footer>
    </div>
  </div>
</div>